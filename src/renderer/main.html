<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Antenna Console</title>
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --header-h: 72px;
      --bg: #0f172a; --panel: #111827; --text: #e5e7eb;
      --accent: #22c55e; --muted: #94a3b8; --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; }
    header {
      height: var(--header-h); display: flex; align-items: center; gap: 16px;
      padding: 10px 14px; background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(16,16,16,0.12));
      border-bottom: 1px solid rgba(255,255,255,0.08); -webkit-app-region: drag;
    }
    .row { display: flex; align-items: center; gap: 12px; }
    header * { -webkit-app-region: no-drag; }
    img.logo { width: 70px; height: 50px; border-radius: 8px; }
    .brand { font-weight: 800; letter-spacing: .4px; }
    .sep { width: 1px; height: 28px; background: rgba(255,255,255,.12); }
    select, button {
      height: 34px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12);
      background: #0b1020; color: var(--text); padding: 0 10px; outline: none;
    }
    button { background: var(--accent); color: #062e12; border: none; font-weight: 700; cursor: pointer; }
    .spacer { flex: 1; }
    .status { font-size: 12px; color: var(--muted); display: flex; flex-direction: column; gap: 2px; min-width: 260px; }
    .error { color: var(--danger); }
    main { height: calc(100% - var(--header-h)); }
    .pill { padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,.08);
       font-size: 12px; }
       /* Espacio extra a la izquierda del header solo en macOS */
body.mac header { padding-left: 96px; }

  </style>
</head>
<body>
  <header>
    <div class="row">
      <img class="logo" src="./SINPRO_LOGO.png" alt="Logo" />
      <div class="brand">SINPRO Console</div>
    </div>
    <div class="sep"></div>

    <div class="row">
      <div id="userBox" class="pill">Usuario: —</div>
      <div id="antennaBox" class="pill">Antena: —</div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <select id="antenna"></select>
      <button id="btnConnect">Conectar</button>
    </div>

    <div class="spacer"></div>

    <div class="status">
      <div id="statusLine">Estado: esperando selección…</div>
      <div id="errorLine" class="error"></div>
    </div>
  </header>
  <main></main>

  <script>
    const $ = (id) => document.getElementById(id)
    const antennaSel = $('antenna'), btnConnect = $('btnConnect')
    const userBox = $('userBox'), antennaBox = $('antennaBox')
    const statusLine = $('statusLine'), errorLine = $('errorLine')

    let antennas = []
    let currentAntenna = null

    function setStatus(msg) { statusLine.textContent = `Estado: ${msg}` }
    function setError(msg) { errorLine.textContent = msg || '' }
    function updateHeaderUser(user) {
      userBox.textContent = `Usuario: ${user?.displayName || user?.username || '—'}`
    }
    function updateHeaderAntenna(ant) {
      antennaBox.textContent = `Antena: ${ant?.name || '—'}`
    }

    async function init() {
      const session = await window.api.getSession()
      updateHeaderUser(session.user)

      antennas = await window.api.getAntennas()
      antennaSel.innerHTML = ''
      antennas.forEach(a => {
        const opt = document.createElement('option')
        opt.value = a.id; opt.textContent = a.name
        antennaSel.appendChild(opt)
      })

      if (session.currentAntenna) {
        currentAntenna = session.currentAntenna
        antennaSel.value = currentAntenna.id
        updateHeaderAntenna(currentAntenna)
      }
      setStatus('Listo')
    }

    async function connect() {
      setError('')
      setStatus('Conectando…')
      const antennaId = antennaSel.value
      const res = await window.api.navigateTo(antennaId)
      if (!res.ok) {
        //setError(res.message || 'No se pudo conectar')
        setError('No se pudo conectar')
        setStatus('Error de conexión')
        return
      }
      setError('')
      const ant = antennas.find(a => a.id === antennaId)
      currentAntenna = ant
      updateHeaderAntenna(ant)
      setStatus(`Conectado a ${ant.name}`)
    }

    btnConnect.addEventListener('click', connect)

    // Logs y eventos desde el BrowserView / main process
    window.api.onViewError(msg => setError(msg))
    //window.api.onViewStatus(msg => setStatus(msg))
    window.api.onAntennaChanged(ant => updateHeaderAntenna(ant))

    init().catch(e => setError(String(e)))
  </script>
  <script>
    // Marca el body para estilos específicos de macOS
    if (window.api?.platform === 'darwin') {
      document.body.classList.add('mac')
    }
  </script>
  
</body>
</html>
